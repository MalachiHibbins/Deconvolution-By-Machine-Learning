
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Deconvolution Using Machine Learning</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=f0c89327" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=60c0e2ec"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'intro';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="#">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="None - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="None - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1 current active">
                <a class="reference internal" href="#">
                    De-convolution Project Lab Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 1 - PyTorch Fundamentals</span></p>
<ul class="nav bd-sidenav">

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 2 - Deblurring Methods</span></p>
<ul class="nav bd-sidenav">


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 3 and 4 - Richardson and Lucy Algorithm</span></p>
<ul class="nav bd-sidenav">



</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 5-8 - Neural Networks</span></p>
<ul class="nav bd-sidenav">

</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fintro.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>De-convolution Project Lab Book</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="de-convolution-project-lab-book">
<h1>De-convolution Project Lab Book<a class="headerlink" href="#de-convolution-project-lab-book" title="Link to this heading">#</a></h1>
<section id="contents">
<h2>Contents<a class="headerlink" href="#contents" title="Link to this heading">#</a></h2>
<div class="toctree-wrapper compound">
<span id="document-Week1/1PytorchTutorial"></span><section class="tex2jax_ignore mathjax_ignore" id="learning-pytorch">
<h3>Learning Pytorch<a class="headerlink" href="#learning-pytorch" title="Link to this heading">#</a></h3>
<p>Pytorch is a machine learning library and will be used in this project to build and train neural networks. It is built on top of the tensor library <code class="docutils literal notranslate"><span class="pre">torch</span></code>, which is a library for high performance numerical computing.</p>
<section id="aims">
<h4>Aims<a class="headerlink" href="#aims" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Practice using and troubleshooting pytorch</p></li>
<li><p>Understand the advantages of using pytorch over numpy</p></li>
<li><p>Build a basic machine learning algorithm</p></li>
</ul>
</section>
<section id="tensors">
<h4>Tensors<a class="headerlink" href="#tensors" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>A specialized data structure very similar to numpy arrays</p></li>
<li><p>Similar to numpy arrays but can also run on the GPU as well as the CPU, meaning thousands of operations can be handled simultaneously. Making them a more suitable data structure for training neural networks.</p></li>
<li><p><strong>TLDR they are like numpy arrays but with the ability to run on high performance hardware</strong></p></li>
</ul>
<section id="basic-tensor-examples">
<h5>Basic Tensor Examples<a class="headerlink" href="#basic-tensor-examples" title="Link to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">torch</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torch&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># From 2d list</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
<span class="n">x_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># From numpy array</span>
<span class="n">np_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">x_np</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Overides initial x_data with the same shape but random values</span>

<span class="n">x_rand</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_rand</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([[0.0394, 0.2424],
        [0.1560, 0.1370]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="loading-a-dataset">
<h5>Loading a dataset<a class="headerlink" href="#loading-a-dataset" title="Link to this heading">#</a></h5>
<p>Below is an example of how to load the Fasion-MINST dataset from TorchVision. The dataset contains 60,000 training examples and 10,000 test examples. Each example comprises a 28x28 greyscale image and an associated label</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">ToTensor</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="c1"># where the train test data is stored</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># specifies training or testing dataset</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># specifies if its local or on internet</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ToTensor</span><span class="p">()</span> <span class="c1"># specifies the type it is transformed to</span>
<span class="p">)</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ToTensor</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="displaying-random-items-from-dataset">
<h5>Displaying random items from dataset<a class="headerlink" href="#displaying-random-items-from-dataset" title="Link to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;T-Shirt&quot;</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Trouser&quot;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;Pullover&quot;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;Dress&quot;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;Coat&quot;</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;Sandal&quot;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;Shirt&quot;</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s2">&quot;Sneaker&quot;</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s2">&quot;Bag&quot;</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s2">&quot;Ankle Boot&quot;</span><span class="p">,</span>
<span class="p">}</span> <span class="c1"># Labels for each of the clothes in the dataset</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training_data</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">training_data</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">labels_map</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d17471d5a2104296e05dfebdf2af24ece1aead6b72aa68bd5423403deb9eddd9.png" src="_images/d17471d5a2104296e05dfebdf2af24ece1aead6b72aa68bd5423403deb9eddd9.png" />
</div>
</div>
</section>
</section>
<section id="example-a-basic-machine-learning-algorithm-with-pytorch">
<h4>Example: A basic machine learning algorithm with pytorch<a class="headerlink" href="#example-a-basic-machine-learning-algorithm-with-pytorch" title="Link to this heading">#</a></h4>
<p>Firstly random input and output data is generated. Here <span class="math notranslate nohighlight">\(x\)</span> will represent the angle in radians and <span class="math notranslate nohighlight">\(y\)</span> will represent the sin of that angle, being predicted. <span class="math notranslate nohighlight">\(y^-\)</span> is the prediction of <span class="math notranslate nohighlight">\(y\)</span>. The loss function is given as:
$<span class="math notranslate nohighlight">\(L = \sum^n_{i=1} (y_i^--y_i)^2\)</span><span class="math notranslate nohighlight">\(
Minimizing the loss function means the predicted curve gets closer to the true curve. The loss is minimized by computing the gradient of \)</span>L<span class="math notranslate nohighlight">\( with respect to each parameter.
\)</span><span class="math notranslate nohighlight">\(\frac{\partial L}{\partial a_{t}} = 2 \sum^n_{i=1} (y_i^- - y_i)\)</span><span class="math notranslate nohighlight">\(
\)</span><span class="math notranslate nohighlight">\(\frac{\partial L}{\partial b_{t}} = 2 \sum^n_{i=1} (y_i^- - y_i)x_i\)</span><span class="math notranslate nohighlight">\(
\)</span><span class="math notranslate nohighlight">\(\frac{\partial L}{\partial c_{t}} = 2 \sum^n_{i=1} (y_i^- - y_i)x_i^2\)</span><span class="math notranslate nohighlight">\(
\)</span><span class="math notranslate nohighlight">\(\frac{\partial L}{\partial d_{t}} = 2 \sum^n_{i=1} (y_i^- - y_i)x_i^3\)</span><span class="math notranslate nohighlight">\(
These gradients are then used to update the parameters using gradient descent.
\)</span><span class="math notranslate nohighlight">\(a_{t+1} = a_t - \eta \frac{\partial L}{\partial a_t}\)</span><span class="math notranslate nohighlight">\(
\)</span><span class="math notranslate nohighlight">\(b_{t+1} = b_t - \eta \frac{\partial L}{\partial b_t}\)</span><span class="math notranslate nohighlight">\(
\)</span><span class="math notranslate nohighlight">\(c_{t+1} = c_t - \eta \frac{\partial L}{\partial c_t}\)</span><span class="math notranslate nohighlight">\(
\)</span><span class="math notranslate nohighlight">\(d_{t+1} = d_t - \eta \frac{\partial L}{\partial d_t}\)</span>$</p>
<p>Where <span class="math notranslate nohighlight">\(\eta\)</span> is the learning rate, a hyperparameter that controls how much to change the parameters in response to the computed gradients. <em><span class="math notranslate nohighlight">\(\eta\)</span> is initially set to be low to visualize the effects of gradient descent</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="c1"># Generate random input and output data</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Randomly initialise weights for polynomial</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="c1"># colours for the graph</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-6</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">):</span>
    <span class="c1"># predict y</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">d</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span>
    
    <span class="c1"># compute loss</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    
    <span class="c1"># compute gradients with respect to a, b, c, d</span>
    <span class="n">grad_y_pred</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">grad_a</span> <span class="o">=</span> <span class="n">grad_y_pred</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">grad_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_y_pred</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">grad_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_y_pred</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">grad_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_y_pred</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="c1"># update weights</span>
    <span class="n">a</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">grad_a</span>
    <span class="n">b</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">grad_b</span>
    <span class="n">c</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">grad_c</span>
    <span class="n">d</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">grad_d</span>
    
    <span class="k">if</span> <span class="n">t</span> <span class="o">%</span> <span class="mi">250</span> <span class="o">==</span> <span class="mi">249</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fitting a cubic function to sin(x)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;y_pred: </span><span class="si">{</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> trials&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;y=sin(x)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>249 678.7615356445312
499 260.70501708984375
749 104.14237976074219
999 45.139129638671875
1249 22.75472640991211
1499 14.203689575195312
1749 10.913901329040527
1999 9.639151573181152
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x74267d270690&gt;]
</pre></div>
</div>
<img alt="_images/8b2653390e73eb5db134944e8c71a05f6eaca27b5ea9fb344f08981e667d86f0.png" src="_images/8b2653390e73eb5db134944e8c71a05f6eaca27b5ea9fb344f08981e667d86f0.png" />
</div>
</div>
</section>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-Week2/12DFowierTransforms"></span><section class="tex2jax_ignore mathjax_ignore" id="fourier-transforms-in-2d">
<h3>Fourier Transforms in 2D<a class="headerlink" href="#fourier-transforms-in-2d" title="Link to this heading">#</a></h3>
<p>Fourier Analysis offers a way to analyse images in terms of their frequency components. This is important in image processing, as it can offer a better description of an image rather than to say sharp/blury or clear/noisy. Furthermore fourier transfomrs are an important tool to understand how different filters work in the frequency domain.</p>
<section id="aims">
<h4>Aims<a class="headerlink" href="#aims" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>To compute the 2D fourier transform of basic images</p></li>
<li><p>To understand how different image features (edges, lines, gradients) are represented in the frequency domain</p></li>
</ul>
</section>
<section id="theory">
<h4>Theory<a class="headerlink" href="#theory" title="Link to this heading">#</a></h4>
<p>A 2D Fourier Transform or a discrtete Fourier Transform (DFT) transforms a 2D signal (like an image) from the spartial domain to the frequency domain. The 2D Fourier transform of an image does not have a an analytic result (the result is a table of values rather than an analytic expression as in the 1D case), it however possible to visualise the results of a 2D fourier transform. The DFT is similarly to the 1D case :</p>
<div class="math notranslate nohighlight">
\[F(u, v) = \sum_{x=0}^{M-1} \sum_{y=0}^{N-1} f(x, y) e^{-2\pi i \left(\frac{ux}{M} + \frac{vy}{N}\right)}\]</div>
<p>and its inverse is given by:</p>
<div class="math notranslate nohighlight">
\[f(x, y) = \frac{1}{MN} \sum_{u=0}^{M-1} \sum_{v=0}^{N-1} F(u, v) e^{2\pi i \left(\frac{ux}{M} + \frac{vy}{N}\right)}\]</div>
<p>Where <span class="math notranslate nohighlight">\(f(x,y)\)</span> is the input image, <span class="math notranslate nohighlight">\(F(u,v)\)</span> is the fourier transform of the image, and <span class="math notranslate nohighlight">\(M\)</span> and <span class="math notranslate nohighlight">\(N\)</span> are the dimensions of the image. The variables <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> are the spatial coordinates, while <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span> are the frequency coordinates.</p>
</section>
<section id="load-image">
<h4>Load image<a class="headerlink" href="#load-image" title="Link to this heading">#</a></h4>
<p>First 4 basic images were loaded and there fourier transforms were analyzed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Load images</span>
<span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;Images/&#39;</span>
<span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LongLine.png&#39;</span><span class="p">,</span> <span class="s1">&#39;ShortLine.png&#39;</span><span class="p">,</span> <span class="s1">&#39;BigSquare.png&#39;</span><span class="p">,</span> <span class="s1">&#39;SmallSquare.png&#39;</span><span class="p">]</span>
<span class="n">img_tensors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">image</span>  <span class="c1"># Replace with your image path</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(),</span>  <span class="c1"># Convert to grayscale</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>  <span class="c1"># Resize to 64x64 for simplicity</span>
    <span class="p">])</span>
    <span class="n">img_tensor</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># Remove channel dimension if grayscale</span>
    <span class="n">img_tensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">torch</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torchvision&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="displaying-images">
<h4>Displaying Images<a class="headerlink" href="#displaying-images" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display the images</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sharex</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7a2166398e68b88469e872c753e6b4ffaa98fa0eb178403c4743f5436352de55.png" src="_images/7a2166398e68b88469e872c753e6b4ffaa98fa0eb178403c4743f5436352de55.png" />
</div>
</div>
</section>
<section id="hypothesizing-fourier-transform-results">
<h4>Hypothesizing Fourier transform results<a class="headerlink" href="#hypothesizing-fourier-transform-results" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Image 1:</strong> A thin horizontal line along the entire x-axis is made up from a single component with a frequency of 0. Much like a 1D fourier transform the fourier transform of this should be a bright central line along the u-axis (the x frequency axis).</p></li>
<li><p><strong>Image 2:</strong> A thin horizontal line along part of the x-axis is made up from a range of low frequency components. The fourier transform of this should be a bright central line along the u-axis (representing the zero frequency line) but with some width to it.</p></li>
<li><p><strong>Image 3:</strong> A large square in the center of the image is made up from a range of low frequency components, due to the sharp edges of the square.</p></li>
<li><p><strong>Image 4:</strong> A small square in the center of the image is going to be made up from higher frequency components than image 3, since the square is smaller.</p></li>
</ul>
</section>
<section id="d-dft-using-pytorch">
<h4>2D DFT using PyTorch<a class="headerlink" href="#d-dft-using-pytorch" title="Link to this heading">#</a></h4>
<p>By applying the fast fourier transform (FFT) function in PyTorch, the 2D DFT of the images were calculated. The FFT function in PyTourch uses the Cooley-Tukey algorithm which has efficency <span class="math notranslate nohighlight">\(\mathbb{O}N\log{N}\)</span>, significantly faster than direct DFT. It is expected that the DFT of the first imageâ€¦</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img_tensor_fs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">magnitude_spectrum_tensors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">img_tensor</span> <span class="ow">in</span> <span class="n">img_tensors</span><span class="p">:</span>
    <span class="n">img_tensor_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">))</span>
    <span class="n">img_tensor_fs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_tensor_f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="display-results">
<h4>Display results<a class="headerlink" href="#display-results" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>


<span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
<span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]</span>
<span class="n">freq_xlabels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">]</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spatial Domain&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Frequency Domain (log scale)&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="c1"># Spatial domain</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="c1"># Frequency domain</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img_tensor_fs</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">freq_xlabels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5ced7db842d2cd0fd23eaba2cb7d8b42c1f4ea1e38e776343e2f909746a674e1.png" src="_images/5ced7db842d2cd0fd23eaba2cb7d8b42c1f4ea1e38e776343e2f909746a674e1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

<span class="n">center</span> <span class="o">=</span> <span class="mi">256</span><span class="o">//</span><span class="mi">2</span>
<span class="n">square_size</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">half_square</span> <span class="o">=</span> <span class="n">square_size</span> <span class="o">//</span> <span class="mi">2</span>

<span class="n">img</span><span class="p">[</span><span class="n">center</span><span class="o">-</span><span class="n">half_square</span><span class="p">:</span><span class="n">center</span><span class="o">+</span><span class="n">half_square</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">center</span><span class="o">-</span><span class="n">half_square</span><span class="p">:</span><span class="n">center</span><span class="o">+</span><span class="n">half_square</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fourier-transform-of-real-image">
<h4>Fourier transform of real image<a class="headerlink" href="#fourier-transform-of-real-image" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Forier transformed pigeon</span>
<span class="n">image_path</span> <span class="o">=</span> <span class="s2">&quot;Images/pigeon.jpeg&quot;</span>

<span class="n">pigeon</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(),</span>  <span class="c1"># Convert to grayscale</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)),</span> <span class="c1"># Resize to 256x256 to speed up processing</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>  
    <span class="p">])</span>
<span class="n">pigeon_tensor</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">pigeon</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># Remove channel dimension if grayscale</span>
<span class="n">box_tensor</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">fft_img_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">pigeon_tensor</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fft_img_tensor</span><span class="p">)),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pigeon_tensor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span> <span class="mi">11</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>         <span class="n">transforms</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(),</span>  <span class="c1"># Convert to grayscale</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>         <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)),</span> <span class="c1"># Resize to 256x256 to speed up processing</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>         <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>  
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">pigeon_tensor</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">pigeon</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># Remove channel dimension if grayscale</span>
<span class="ne">---&gt; </span><span class="mi">11</span> <span class="n">box_tensor</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="n">fft_img_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">pigeon_tensor</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="nn">File ~/anaconda3/envs/BScProject/lib/python3.11/site-packages/torchvision/transforms/transforms.py:137,</span> in <span class="ni">ToTensor.__call__</span><span class="nt">(self, pic)</span>
<span class="g g-Whitespace">    </span><span class="mi">129</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pic</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span><span class="sd">     Args:</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span><span class="sd">         pic (PIL Image or numpy.ndarray): Image to be converted to tensor.</span>
<span class="sd">   (...)    135         Tensor: Converted image.</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">137</span>     <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span>

<span class="nn">File ~/anaconda3/envs/BScProject/lib/python3.11/site-packages/torchvision/transforms/functional.py:142,</span> in <span class="ni">to_tensor</span><span class="nt">(pic)</span>
<span class="g g-Whitespace">    </span><span class="mi">140</span>     <span class="n">_log_api_usage_once</span><span class="p">(</span><span class="n">to_tensor</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">141</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">F_pil</span><span class="o">.</span><span class="n">_is_pil_image</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_is_numpy</span><span class="p">(</span><span class="n">pic</span><span class="p">)):</span>
<span class="ne">--&gt; </span><span class="mi">142</span>     <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pic should be PIL Image or ndarray. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">144</span> <span class="k">if</span> <span class="n">_is_numpy</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_numpy_image</span><span class="p">(</span><span class="n">pic</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">145</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pic should be 2/3 dimensional. Got </span><span class="si">{</span><span class="n">pic</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2"> dimensions.&quot;</span><span class="p">)</span>

<span class="ne">TypeError</span>: pic should be PIL Image or ndarray. Got &lt;class &#39;torch.Tensor&#39;&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="results">
<h4>Results<a class="headerlink" href="#results" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>For the first two images there are additional low frequency components. This is because the line is not infinitely thin, and so there are some low frequency components to represent the thickness of the line in the <span class="math notranslate nohighlight">\(v\)</span> direction (the <span class="math notranslate nohighlight">\(y\)</span> frequency axis).</p></li>
<li><p>DFTs mostly align with the predictions. Except for perhaps image 4 where there are more higher frequency components in the <span class="math notranslate nohighlight">\(u\)</span> direction than expected.</p></li>
</ul>
</section>
<section id="conclusion">
<h4>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h4>
</section>
</section>
<span id="document-Week2/2ImageDebluring"></span><section class="tex2jax_ignore mathjax_ignore" id="basics-of-image-de-blurring">
<h3>Basics of image de-blurring<a class="headerlink" href="#basics-of-image-de-blurring" title="Link to this heading">#</a></h3>
<p>Blur filters are low pass filters, they remove high frequency components which are usually associated with noise. Low pass filters applied to images makes them look bury. A pixel is blurred by taking the average over the surrounding pixels. Doing this for each pixel individually is slow but can be sped up using convolution.</p>
<section id="contents">
<h4>Contents<a class="headerlink" href="#contents" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Image noise</p></li>
<li><p>How convolution can be used to speed up image filtering?</p></li>
<li><p>The process which noise and blur effect images</p></li>
<li><p>Convolution and de-convolution to blur and de-blur images</p></li>
<li><p>De-convolution in de-blur noisy images</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">torch</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torchvision&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-images">
<h4>Load images<a class="headerlink" href="#load-images" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load images</span>
<span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;Images/&#39;</span>
<span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>
<span class="n">image</span> <span class="o">=</span> <span class="s1">&#39;pigeon.jpeg&#39;</span>

<span class="n">image_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">image</span>  <span class="c1"># Replace with your image path</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(),</span>  <span class="c1"># Convert to grayscale</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)),</span> <span class="c1"># Resize to 256x256 to speed up processing</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>  
    <span class="p">])</span>
<span class="n">img_tensor</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># Remove channel dimension</span>

<span class="c1"># Display the image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(-0.5), np.float64(255.5), np.float64(255.5), np.float64(-0.5))
</pre></div>
</div>
<img alt="_images/15962b066531de0ac47604357b02c2b3f8c8b5613bf736374b56b5cb1a8238da.png" src="_images/15962b066531de0ac47604357b02c2b3f8c8b5613bf736374b56b5cb1a8238da.png" />
</div>
</div>
</section>
<section id="shot-noise-poisson-noise">
<h4>Shot noise (poisson noise)<a class="headerlink" href="#shot-noise-poisson-noise" title="Link to this heading">#</a></h4>
<p>Occurs when there is a finite number of particles that carry energy, such as photons in an image sensor or electrons in a circuit. Shot noise is one of the main types of noise that degrade image quality.</p>
<p>Shot noise follows a Poisson distribution because:</p>
<ol class="arabic simple">
<li><p><strong>Discrete countable events</strong>: Each photon arrival is a discrete, countable event</p></li>
<li><p><strong>Constant Average Rate <span class="math notranslate nohighlight">\(\lambda\)</span></strong>: The average rate of photon arrivals depends on the light intensity (brighter = more photons per second)</p></li>
<li><p><strong>No simultaneous Events</strong>: In any tiny time interval, the probability of a photon arriving is very small. In an infinitesimally small window the probability of more than one event occuring is <span class="math notranslate nohighlight">\(\approx 0\)</span></p></li>
<li><p><strong>Independent</strong>: Previous photon arrivals donâ€™t affect future arrivals</p></li>
</ol>
<p>These conditions exactly match the assumptions of a Poisson process. The number of photons detected in a fixed time period (<span class="math notranslate nohighlight">\(\Delta t\)</span>) follows:</p>
<div class="math notranslate nohighlight">
\[P(k) = \frac{\lambda^k e^{-\lambda}}{k!}\]</div>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(k\)</span> = number of photons detected</p></li>
<li><p><span class="math notranslate nohighlight">\(\lambda\)</span> = average number of photons arriving in <span class="math notranslate nohighlight">\(\Delta t\)</span> (proportional to light intensity)</p></li>
<li><p>Higher <span class="math notranslate nohighlight">\(\lambda\)</span> = brighter pixel = more photons = less relative noise</p></li>
<li><p>Lower <span class="math notranslate nohighlight">\(\lambda\)</span> = darker pixel = fewer photons = more relative noise</p></li>
</ul>
<p>This is why images taken in low light (few photons) are much noisier than images in bright light (many photons).</p>
</section>
<section id="method">
<h4>Method<a class="headerlink" href="#method" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>The number of photons in each pixel was simulated depending on the brightness of the pixel and its scale factor (<span class="math notranslate nohighlight">\(s\)</span>).</p></li>
<li><p>The photon count was set as the expected number of photons in the pixel <span class="math notranslate nohighlight">\(sP(x)\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">torch.poisson</span></code> randomly generates the number of photons present due to random variation</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_poisson_noise</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add realistic Poisson (shot) noise to an image</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        image: Input tensor in range [0,1]</span>
<span class="sd">        scale_factor: Higher values = less noise (more photons)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to photon counts (scale up to simulate photon detection)</span>
    <span class="n">photon_counts</span> <span class="o">=</span> <span class="n">image</span> <span class="o">*</span> <span class="n">scale_factor</span>
    
    <span class="c1"># Apply Poisson noise </span>
    <span class="n">noisy_photons</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">photon_counts</span><span class="p">)</span>
    
    <span class="c1"># Convert back to [0,1] range</span>
    <span class="n">noisy_image</span> <span class="o">=</span> <span class="n">noisy_photons</span> <span class="o">/</span> <span class="n">scale_factor</span>
    
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">noisy_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Create noisy images with different noise levels</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  

<span class="c1"># Low noise (high photon count)</span>
<span class="n">noisy_low</span> <span class="o">=</span> <span class="n">add_poisson_noise</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>

<span class="c1"># Medium noise </span>
<span class="n">noisy_medium</span> <span class="o">=</span> <span class="n">add_poisson_noise</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># High noise (low photon count - like low light)</span>
<span class="n">noisy_high</span> <span class="o">=</span> <span class="n">add_poisson_noise</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Display results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">noisy_low</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;scale factor = 5000&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">noisy_medium</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;scale factor = 500&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">noisy_high</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;scale factor = 50&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/584f7b9b4cace48341e5dbbbbaeab4ece4bbddbfb02d6976069add1870f227e7.png" src="_images/584f7b9b4cace48341e5dbbbbaeab4ece4bbddbfb02d6976069add1870f227e7.png" />
</div>
</div>
</section>
<section id="results">
<h4>Results<a class="headerlink" href="#results" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>The smaller the scale factor (number of photons) the noisier the image, which in reality is what happens.</p></li>
<li><p>A key property of a poisson distribution is that the mean and variance are both <span class="math notranslate nohighlight">\(\lambda\)</span>. Increasing <span class="math notranslate nohighlight">\(s\)</span> increases <span class="math notranslate nohighlight">\(\lambda\)</span> and therefore should increase the absolute noise. The relative noise decreases, this is clear from looking at the signal to noise ratio <span class="math notranslate nohighlight">\(R\)</span>
$<span class="math notranslate nohighlight">\(R = \frac{\text{noise}}{\text{signal}} = \frac{\sqrt{\lambda}}{\lambda} = \frac{1}{\sqrt{\lambda}}\)</span>$</p></li>
<li><p>This explains why higher photon counts produce clearer images.</p></li>
</ul>
</section>
<section id="filtering-in-2d">
<h4>Filtering in 2D<a class="headerlink" href="#filtering-in-2d" title="Link to this heading">#</a></h4>
<p>Filtering in 2D works by acting a discrete function q (dimensions <span class="math notranslate nohighlight">\(X\)</span>, <span class="math notranslate nohighlight">\(M\)</span>) on an underlying image p:
$<span class="math notranslate nohighlight">\(p'(x,y) = \sum_{n=-X}^{X} \sum_{m=-Y}^{Y} p(x+n,y+m) \cdot q(n,m)\)</span>$</p>
</section>
<section id="filtering-example-the-box-filter">
<h4>Filtering Example: The box filter<a class="headerlink" href="#filtering-example-the-box-filter" title="Link to this heading">#</a></h4>
<p>The box filter is a type of low pass filter which helps to remove noise and blurs images. It works by setting the pixel value <span class="math notranslate nohighlight">\(p_{x,y}\)</span> to be the average of the <span class="math notranslate nohighlight">\(N\)</span> pixels above it and <span class="math notranslate nohighlight">\(M\)</span> pixels below it.</p>
<div class="math notranslate nohighlight">
\[\tag{1} p'(x,y) = \frac{1}{(2N+1)(2M+1)} \sum_{n=-N}^{N} \sum_{m=-M}^{M} p(x+n,y+m)\]</div>
<p>This algorithm is incredibly slow when implemented with nested loops since computing each pixel value has an efficiency of <span class="math notranslate nohighlight">\(\mathbb{O}(N^2)\)</span> which for the overall image will have efficiency <span class="math notranslate nohighlight">\(\mathbb{O}(N^4)\)</span>, since each pixel needs to be filtered in the <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> direction. This can be rapidly increased using convolution.</p>
</section>
<section id="convolution">
<h4>Convolution<a class="headerlink" href="#convolution" title="Link to this heading">#</a></h4>
<p>The convolution of two functions is given by the multiplication of the fourier transforms. The convolution theorem states that the convolution of two functions <span class="math notranslate nohighlight">\(v(x)\)</span> and <span class="math notranslate nohighlight">\(u(x)\)</span> can be given in terms of their fourier transforms <span class="math notranslate nohighlight">\(V(k)\)</span> and <span class="math notranslate nohighlight">\(U(k)\)</span> respectively:</p>
<div class="math notranslate nohighlight">
\[f(x) = v(x) * u(x) = \mathcal{F}^{-1}\{V(k) \cdot U(k)\} \tag{2}\]</div>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(*\)</span> denotes convolution</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathcal{F}^{-1}\)</span> is the inverse Fourier transform</p></li>
<li><p><span class="math notranslate nohighlight">\(\cdot\)</span> denotes pointwise multiplication
Convolution in spatial domain is the same as multiplication in frequency domain. The convolution method can greatly improve the efficiency of applying filters especially when using the fast fourier transform. The nested loop approach has efficiency <span class="math notranslate nohighlight">\(\mathbb{O}(N^4)\)</span> (<span class="math notranslate nohighlight">\(\mathbb{O}(N^2)\)</span> per pixel) where as transfering to the frequency domain increases the efficency to <span class="math notranslate nohighlight">\(\mathbb{O}(N^2) \log(N)\)</span> (<span class="math notranslate nohighlight">\(\mathbb{O}(\log{N})\)</span> per pixel). Furthermore there are advantages to using the better optimized pytorch tensors compared to using inefficient python loops.
Convolution corresponds to numerically represents multiplication of every value in the list <span class="math notranslate nohighlight">\(v(x)\)</span> with every value in the list <span class="math notranslate nohighlight">\(u(x)\)</span>.</p></li>
</ul>
<section id="the-box-filter">
<h5>The box filter<a class="headerlink" href="#the-box-filter" title="Link to this heading">#</a></h5>
<p>The box function is the â€œconvolution kernelâ€ for this type of filter, which describes which surrounding pixel values will be used to form the filtered pixel value <span class="math notranslate nohighlight">\(p'_{x,y}\)</span>. It is described as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\text{box}_{N,M}(n,m) = \begin{cases} 
\frac{1}{(2N+1)(2M+1)} &amp; \text{if} -N \leq n \leq N \text{ and} - M \leq m \leq M \\
0 &amp; \text{else}
\end{cases}\end{split}\]</div>
<p>e.g.</p>
<div class="math notranslate nohighlight">
\[\text{box}_{2,2}(n,m) = \]</div>
<p>To blur the image the the box function is applied to the image using convolution.</p>
<div class="math notranslate nohighlight">
\[p'(x,y) = p(x,y) * \text{box}_{N,M}(x,y)\]</div>
<p>or generally
$<span class="math notranslate nohighlight">\(p'(x,y) = p(x,y) * q(x,y)\)</span>$</p>
<section id="creating-box-functions">
<h6>Creating box functions<a class="headerlink" href="#creating-box-functions" title="Link to this heading">#</a></h6>
<p>Different shapes of box functions were created and there bluing effects were analyzed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">box_function</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">M</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kernel</span>

<span class="n">val</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">square_kernel</span> <span class="o">=</span> <span class="n">box_function</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="n">horizontal_kernel</span> <span class="o">=</span> <span class="n">box_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="n">vertical_kernel</span> <span class="o">=</span> <span class="n">box_function</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="carry-out-convolution">
<h6>Carry out convolution<a class="headerlink" href="#carry-out-convolution" title="Link to this heading">#</a></h6>
<div class="math notranslate nohighlight">
\[p'(x,y) = p(x,y) * \text{box}_{N,M}(x,y)\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="k">def</span> <span class="nf">convolution</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">):</span>    
    <span class="c1"># Apply convolution with padding to maintain image size</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">kernel</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">padding_mode</span> <span class="o">==</span> <span class="s1">&#39;zeros&#39;</span><span class="p">:</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">padding_mode</span> <span class="o">==</span> <span class="s1">&#39;circular&#39;</span><span class="p">:</span>
        <span class="n">image_padded</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">image</span><span class="p">[:,</span> <span class="o">-</span><span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">]:],</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">:</span><span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">image_padded</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">image_padded</span><span class="p">[</span><span class="o">-</span><span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">]:,</span> <span class="p">:],</span> <span class="n">image_padded</span><span class="p">,</span> <span class="n">image_padded</span><span class="p">[:</span><span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">image_padded</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">padding_mode</span> <span class="o">==</span> <span class="s1">&#39;reflect&#39;</span><span class="p">:</span>
        <span class="n">image_padded</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">image_padded</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">padding_mode</span> <span class="o">==</span> <span class="s1">&#39;replicate&#39;</span><span class="p">:</span>
        <span class="n">image_padded</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">image_padded</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">padding_mode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>   
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported padding mode: </span><span class="si">{</span><span class="n">padding_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Remove batch and channel dimensions: [1, 1, H, W] -&gt; [H, W]</span>
    <span class="k">return</span> <span class="n">filtered</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">square_kernel</span><span class="p">,</span> <span class="n">horizontal_kernel</span><span class="p">,</span> <span class="n">vertical_kernel</span><span class="p">]):</span>
    <span class="n">filtered_img</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">filtered_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;N = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">, M = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;N = 1, M = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;N = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">, M = 1&#39;</span><span class="p">]</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/012aa73f5246571fb7d0c830093a0f28da83155bb6f18c37803f3f26f1641357.png" src="_images/012aa73f5246571fb7d0c830093a0f28da83155bb6f18c37803f3f26f1641357.png" />
</div>
</div>
</section>
<section id="discussion">
<h6>Discussion<a class="headerlink" href="#discussion" title="Link to this heading">#</a></h6>
<ul class="simple">
<li><p>The results show that the square box filter causes equal bluing in both directions.</p></li>
<li><p>The horizontal box filter causes bluing in only the horizontal direction.</p></li>
<li><p>Similarly for the vertical box filter.</p></li>
</ul>
</section>
</section>
</section>
<section id="de-convolution">
<h4>De-convolution<a class="headerlink" href="#de-convolution" title="Link to this heading">#</a></h4>
<p>The images can be de-blurred via de-convolution using the convolution kernel. De convolution is working out <span class="math notranslate nohighlight">\(v(x)\)</span> knowing <span class="math notranslate nohighlight">\(f(x)\)</span> and <span class="math notranslate nohighlight">\(u(x)\)</span> given <span class="math notranslate nohighlight">\(f(x) = v(x) * u(x)\)</span> . The inverse (de-convolution) is:
$<span class="math notranslate nohighlight">\(v(x) = \mathcal{F}^{-1}\left\{\frac{F(k)}{H(k)}\right\} \tag{3}\)</span><span class="math notranslate nohighlight">\(
Since the convolution kernel for the blured images is known the original image can be recovered.
\)</span><span class="math notranslate nohighlight">\(p(x,y) = \mathcal{F}^{-1}\left\{\frac{P'(u,v)}{B(u,v)}\right\} \tag{4}\)</span>$</p>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(B(k) = \mathcal{F}\{h(x)\}\)</span> is the Fourier transform of the blur kernel in this case the fourier transform of the box function</p></li>
<li><p><span class="math notranslate nohighlight">\(P'(u,v) = \mathcal{F}\{p'(x,y)\}\)</span> is the Fourier transform of the blurred image</p></li>
</ul>
</section>
<section id="convolving-and-then-de-convolving-the-image">
<h4>Convolving and then de-convolving the image<a class="headerlink" href="#convolving-and-then-de-convolving-the-image" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>The image is first blurred using convolution with the box function</p></li>
<li><p>The blurred image is then de-blurred using de-convolution with the box function</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">deconvolution</span><span class="p">(</span><span class="n">blurred_image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
    <span class="c1"># Compute Fourier transforms</span>
    <span class="n">P_blurred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">blurred_image</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">s</span><span class="o">=</span><span class="n">blurred_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="c1"># Avoid division by zero by adding a small constant (epsilon)</span>
    <span class="n">B_conj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">B_magnitude_squared</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">B_inv</span> <span class="o">=</span> <span class="n">B_conj</span> <span class="o">/</span> <span class="p">(</span><span class="n">B_magnitude_squared</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
    
    <span class="c1"># Perform deconvolution in the frequency domain</span>
    <span class="n">P_deblurred</span> <span class="o">=</span> <span class="n">P_blurred</span> <span class="o">*</span> <span class="n">B_inv</span>

    <span class="c1"># Inverse Fourier transform to get the deblurred image</span>
    <span class="n">deblurred_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">P_deblurred</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">deblurred_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">square_kernel</span> <span class="o">=</span> <span class="n">box_function</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">square_blured</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">square_kernel</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">)</span>
<span class="n">deblurred_img</span> <span class="o">=</span> <span class="n">deconvolution</span><span class="p">(</span><span class="n">square_blured</span><span class="p">,</span> <span class="n">square_kernel</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">square_blured</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Blurred Image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">deblurred_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Deblurred Image (Square Kernel)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/62a71f982ffc23afd31a93a4be43ca25813666e28e80105e7d2e451939f5adf0.png" src="_images/62a71f982ffc23afd31a93a4be43ca25813666e28e80105e7d2e451939f5adf0.png" />
</div>
</div>
</section>
<section id="id1">
<h4>Discussion<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>The deconvolution process is not perfect. Artifacts are introduced in the image, especially around the edges potentially due to boundary effects and noise amplification.</p></li>
<li><p>Furthermore, the box filter is not a perfect low-pass filter. While it should attenuate higher frequencies, this doesnâ€™t always work due to its frequency response characteristics.</p></li>
<li><p><strong>Counter-example</strong>: A high frequency alternating signal <span class="math notranslate nohighlight">\(p(x) = [..., 1, -1, 1, -1, 1, ...]\)</span> convolved with a 1Ã—1 box filter:
$<span class="math notranslate nohighlight">\(p'(x) = p(x) * \text{box}_1(x)\)</span>$
The high frequency signal passes through unchanged.</p></li>
<li><p><strong>Example of lower frequency attenuation</strong>: A lower frequency signal <span class="math notranslate nohighlight">\(p(x) = [..., 1, -0.5, -0.5, 1, -0.5, -0.5, ...]\)</span> when convolved with <span class="math notranslate nohighlight">\(\text{box}_1\)</span> gives <span class="math notranslate nohighlight">\(\mathbb{0}\)</span>, showing selective frequency attenuation.</p></li>
<li><p>Box filters give each pixel within the â€œboxâ€ equal weighting. In reality pixels closer to the middle will have larger weighting</p></li>
<li><p>Convolving a box filter on a box filter does not give a box filter. This is a problem since applying a box filter twice isnâ€™t doubling the amount of â€œblurâ€.</p></li>
<li><p>Division by small values in <span class="math notranslate nohighlight">\(H(k)\)</span> can amplify noise and introduce artifacts. Especially as the box filter may attenuate certain frequencies to near zero.</p></li>
</ul>
</section>
<section id="padding">
<h4>Padding<a class="headerlink" href="#padding" title="Link to this heading">#</a></h4>
<p>Padding is likely the cause of some of the artifacts seen in the de-blurred images. When convolving near the edges of an image, there are not enough surrounding pixels to apply the filter properly. Padding adds extra pixels around the border of the image to mitigate this issue. In this case</p>
</section>
<section id="gaussian-filters">
<h4>Gaussian filters<a class="headerlink" href="#gaussian-filters" title="Link to this heading">#</a></h4>
<p>The gaussian filter is defined in 1 dimension as:
$<span class="math notranslate nohighlight">\(g_{\sigma}(x) = \frac{1}{\sqrt{2\pi}\sigma} e^{-\frac{x^2}{2\sigma^2}}\)</span><span class="math notranslate nohighlight">\(
or in 2 dimensions as:
\)</span><span class="math notranslate nohighlight">\(g_{\sigma}(x,y) = \frac{1}{2\pi\sigma^2} e^{-\frac{x^2+y^2}{2\sigma^2}}\)</span><span class="math notranslate nohighlight">\(
Where \)</span>\sigma<span class="math notranslate nohighlight">\( is the standard deviation which controls the width of the gaussian. The larger the \)</span>\sigma$ the wider the gaussian and therefore the more blurring that occurs. The gaussian filter is a better low-pass filter than the box filter since it gives more weighting to pixels closer to the center.</p>
</section>
<section id="image-degrading">
<h4>Image Degrading<a class="headerlink" href="#image-degrading" title="Link to this heading">#</a></h4>
<p>images become degraded by convolving the image with a guassian kernel then adding noise.
$<span class="math notranslate nohighlight">\(d(x,y) = p(x,y) * q(x,y) + n(x,y)\)</span><span class="math notranslate nohighlight">\(
then an attempt to recover the original image was made using
\)</span><span class="math notranslate nohighlight">\(p(x,y) = d(x,y) / q(x,y) = \mathcal{F}^{-1}\left\{\frac{D(x,y)}{Q(x,y)}\right\} \tag{4}\)</span>$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gaussian_normalised_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a 2D Gaussian kernel.&quot;&quot;&quot;</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kernel</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Shape: [1, 1, size, size]</span>

<span class="n">gaussian_kernel1</span> <span class="o">=</span> <span class="n">gaussian_normalised_kernel</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">gaussian_blured1</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">gaussian_kernel1</span><span class="p">,</span> <span class="n">padding_mode</span> <span class="o">=</span> <span class="s2">&quot;replicate&quot;</span><span class="p">)</span>
<span class="n">degraded_gaussian_blured1</span> <span class="o">=</span> <span class="n">add_poisson_noise</span><span class="p">(</span><span class="n">gaussian_blured1</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">deblurred_gaussian1</span> <span class="o">=</span> <span class="n">deconvolution</span><span class="p">(</span><span class="n">degraded_gaussian_blured1</span><span class="p">,</span> <span class="n">gaussian_kernel1</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>

<span class="n">gaussian_kernel2</span> <span class="o">=</span> <span class="n">gaussian_normalised_kernel</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">gaussian_blured2</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">gaussian_kernel2</span><span class="p">,</span> <span class="n">padding_mode</span> <span class="o">=</span> <span class="s2">&quot;replicate&quot;</span><span class="p">)</span>
<span class="n">degraded_gaussian_blured2</span> <span class="o">=</span> <span class="n">add_poisson_noise</span><span class="p">(</span><span class="n">gaussian_blured2</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">deblurred_gaussian2</span> <span class="o">=</span> <span class="n">deconvolution</span><span class="p">(</span><span class="n">degraded_gaussian_blured2</span><span class="p">,</span> <span class="n">gaussian_kernel2</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">degraded_gaussian_blured1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Blurred Image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">deblurred_gaussian1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Deblurred Image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">degraded_gaussian_blured2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Blurred Image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">deblurred_gaussian2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Deblurred Image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/42f0c3857743b1b5ee99c5e53ea5ffead93716690211bb43140877e383c90bb0.png" src="_images/42f0c3857743b1b5ee99c5e53ea5ffead93716690211bb43140877e383c90bb0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gaussian_kernel1</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(-0.5), np.float64(9.5), np.float64(9.5), np.float64(-0.5))
</pre></div>
</div>
<img alt="_images/159f781e695d6db70ac573d3fb4c65a8b9ef91628eb61577521646322b82ae17.png" src="_images/159f781e695d6db70ac573d3fb4c65a8b9ef91628eb61577521646322b82ae17.png" />
</div>
</div>
</section>
<section id="id2">
<h4>Discussion<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>The de-bluring from the gaussian filters is significantly better than the box filter, especially for the heavily blured image.</p></li>
<li><p>There are some edge artifacts present in the de-blured images, but not as bad as the box filter.</p></li>
<li><p>This seems to be related to kernel size since larger kernels produce more edge artifacts</p></li>
<li><p>This could be because the code assumes that the image is infinately periodic.</p></li>
</ul>
</section>
<section id="realistic-noise">
<h4>Realistic noise<a class="headerlink" href="#realistic-noise" title="Link to this heading">#</a></h4>
<p>Realistically noise and blur occur together. This time an image will be blured using the gaussian filter and then poisson noise will be added, to simulate realistic image acquisition conditions. The image will then be de-blured, using the convolution kernel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using your existing variables</span>

<span class="n">gaussian_kernel3</span> <span class="o">=</span> <span class="n">gaussian_normalised_kernel</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">no_blur_kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[[[</span><span class="mf">1.0</span><span class="p">]]]])</span>  <span class="c1"># Identity kernel for no blur</span>

<span class="n">blur_levels</span> <span class="o">=</span>  <span class="p">[(</span><span class="n">no_blur_kernel</span><span class="p">,</span> <span class="s1">&#39;No Blur&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">gaussian_kernel2</span><span class="p">,</span> <span class="s1">&#39;Light Blur (Ïƒ=1.0)&#39;</span><span class="p">),</span> 
                <span class="p">(</span><span class="n">gaussian_kernel1</span><span class="p">,</span> <span class="s1">&#39;Heavy Blur (Ïƒ=2.0)&#39;</span><span class="p">)]</span>
<span class="n">noise_levels</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">50000000</span><span class="p">,</span> <span class="s1">&#39;No Noise&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Medium Noise&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;High Noise&#39;</span><span class="p">)]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">noise_levels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">blur_levels</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">noise_scale</span><span class="p">,</span> <span class="n">noise_label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">noise_levels</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">blur_label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blur_levels</span><span class="p">):</span>
        <span class="c1"># Blur then add noise</span>
        <span class="n">blurred</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">)</span>
        <span class="n">noisy_blurred</span> <span class="o">=</span> <span class="n">add_poisson_noise</span><span class="p">(</span><span class="n">blurred</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">noise_scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kernel</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">no_blur_kernel</span><span class="p">):</span>
            <span class="n">deblured</span> <span class="o">=</span> <span class="n">noisy_blurred</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deblured</span> <span class="o">=</span> <span class="n">deconvolution</span><span class="p">(</span><span class="n">noisy_blurred</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">deblured</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">blur_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">noise_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        

<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;Increasing Blur â†’&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;â† Increasing Noise&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.08</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;deblurring_results.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8b20100a8796c8ef88a4a363dd0e2d78740191e3e21c796e812c131573e7bff3.png" src="_images/8b20100a8796c8ef88a4a363dd0e2d78740191e3e21c796e812c131573e7bff3.png" />
</div>
</div>
</section>
<section id="id3">
<h4>Discussion<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Blur on its own can be successfully removed using de convolution.</p></li>
<li><p>However when noise is added the de convolution process generates artifacts which makes it even more difficult to recover the original image.</p></li>
<li><p>After noise present after the de convolution process is no longer random but seems to have more structure than the original noise since there are more distinct patches of black and white.</p></li>
<li><p>This noise due to noise and blur is more visually disturbing than noise or blur.</p></li>
</ul>
</section>
<section id="summary">
<h4>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h4>
<p>De convolution was used to de blur images which had been convolved with a known kernel. This worked very well for images which had been blurred but not corrupted with noise. But realistically acquired images will be blurred and will have noise on top of this. De convoluting the noisy images did not work well and created artifacts in the image, which was visually more disturbing than gaussian noise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">noisy_img_tensor</span> <span class="o">=</span> <span class="n">add_poisson_noise</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">blurred_noisy_img</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">noisy_img_tensor</span><span class="p">,</span> <span class="n">box_function</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">noisy_img_tensor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">blurred_noisy_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;noisy_blurred_image.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2c105a411c7069a6a6a7ce445386da213d75a72b0e817cc850490eeb1014fb43.png" src="_images/2c105a411c7069a6a6a7ce445386da213d75a72b0e817cc850490eeb1014fb43.png" />
</div>
</div>
</section>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-Week3/1richardsonlucy"></span><section class="tex2jax_ignore mathjax_ignore" id="richardson-lucy-algorithm">
<h3>Richardson Lucy Algorithm<a class="headerlink" href="#richardson-lucy-algorithm" title="Link to this heading">#</a></h3>
<p>Even knowing convolution kernel isnâ€™t enough to de-blur an image. This is because any noise present in the image is amplified during de-convolution and adds significant visual disturbances. This section looks at the Richardson Lucy algorithm which is an iterative method for recovering convoluted images which are also corrupted by noise.</p>
<section id="aims">
<h4>Aims<a class="headerlink" href="#aims" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Understand the Richardson Lucy algorithm</p></li>
<li><p>Implement the Richardson Lucy algorithm and deblur images</p></li>
<li><p>Compare the Richardson Lucy algorithm with just using the Fourier transform to deconvolve a noisy image.</p></li>
</ul>
</section>
<section id="theory">
<h4>Theory<a class="headerlink" href="#theory" title="Link to this heading">#</a></h4>
<p>The matrices <span class="math notranslate nohighlight">\(f\)</span>, <span class="math notranslate nohighlight">\(f'\)</span> and <span class="math notranslate nohighlight">\(k\)</span> describe the proportion of light in: the true image, the observed image and the convolution kernel respectively, and are related by either <span class="math notranslate nohighlight">\(f'_i =\sum_j k_{i,j}f_j\)</span> or <span class="math notranslate nohighlight">\(f' = f * k\)</span>. When the letters are unscripted (e.g. <span class="math notranslate nohighlight">\(f\)</span>) that means they are referring to the whole array. When they are scripted (e.g. <span class="math notranslate nohighlight">\(f_{i}\)</span>) then they are referring to the value in the <span class="math notranslate nohighlight">\(i\)</span> th location.</p>
<p>The Richardson Lucy algorithm is an iterative process which predicts predicts the true image accounting for noise:
$<span class="math notranslate nohighlight">\(\hat{f}_j^{t+1} = \hat{f}_j^{t}\sum_i \frac{f'^{t}_i}{\hat{f'}^{t}_i}k_{i,j} \text{  [1]}\)</span>$</p>
<ul class="simple">
<li><p>Where <span class="math notranslate nohighlight">\(\hat{f}_j^{t+1}\)</span> is the <span class="math notranslate nohighlight">\(t+1\)</span> th estimated value of <span class="math notranslate nohighlight">\(f_j\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\hat{f'}_i\)</span> is the predicted light intensity in the observed image given as <span class="math notranslate nohighlight">\(\hat{f'}_i = \sum_j k_{i,j}\hat{f}_j\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\frac{f'^t_i}{\hat{f}^{t}_i}\)</span> is the correcting factor. It determines the difference between the measured light intensity and the prediction of the light intensity from the previous estimate.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(p_{i,j}\)</span> is normalized (<span class="math notranslate nohighlight">\(\sum_j p_{i,j} = 1\)</span>)</p></li>
<li><p>The richardson lucy algorithm often converges as the process is self correcting [1].</p></li>
</ul>
<p>Using convolution the algorithm can be written for the 2D case:
$<span class="math notranslate nohighlight">\(\hat{p}^{t+1} = \hat{p}^{t} \cdot \left(\frac{d^t}{\hat{d}^{t}}*q^* \right)\)</span>$</p>
<ul class="simple">
<li><p>Where <span class="math notranslate nohighlight">\(\hat{p}^{t}\)</span> is the <span class="math notranslate nohighlight">\(t\)</span> th estimated value of <span class="math notranslate nohighlight">\(p\)</span>.</p></li>
<li><p>Where <span class="math notranslate nohighlight">\(q^*\)</span> is the mirrored convolution kernel.</p></li>
<li><p><span class="math notranslate nohighlight">\(\hat{d}\)</span> is the predicted light intensity in the observed image given as: <span class="math notranslate nohighlight">\(\hat{d}^{t} = \hat{p}^{t} * q\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\frac{d^t_i}{\hat{d}^{t}_i}\)</span> is the correcting factor.</p></li>
</ul>
</section>
<section id="basic-1d-implementat">
<h4>Basic 1D implementat<a class="headerlink" href="#basic-1d-implementat" title="Link to this heading">#</a></h4>
</section>
<section id="python-implementation">
<h4>Python implementation<a class="headerlink" href="#python-implementation" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">ImageDebluring</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">torch</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torchvision&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="degrading-the-image">
<h4>Degrading the image<a class="headerlink" href="#degrading-the-image" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load images</span>
<span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;Images/&#39;</span>
<span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>
<span class="n">image</span> <span class="o">=</span> <span class="s1">&#39;pigeon.jpeg&#39;</span>

<span class="n">image_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">image</span>  <span class="c1"># Replace with your image path</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(),</span>  <span class="c1"># Convert to grayscale</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)),</span> <span class="c1"># Resize to 256x256 to speed up processing</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>  
    <span class="p">])</span>
<span class="n">img_tensor</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># Remove channel dimension</span>

<span class="c1"># Display the image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(-0.5), np.float64(255.5), np.float64(255.5), np.float64(-0.5))
</pre></div>
</div>
<img alt="_images/15962b066531de0ac47604357b02c2b3f8c8b5613bf736374b56b5cb1a8238da.png" src="_images/15962b066531de0ac47604357b02c2b3f8c8b5613bf736374b56b5cb1a8238da.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">convolve2d</span> <span class="k">as</span> <span class="n">conv2</span>

<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">color</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">restoration</span>


<span class="n">iters_rl</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">gaussian_normalised_kernel</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">blury_image</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
<span class="n">degraded_image</span> <span class="o">=</span> <span class="n">add_poisson_noise</span><span class="p">(</span><span class="n">blury_image</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">restored_image_ft</span> <span class="o">=</span> <span class="n">deconvolution</span><span class="p">(</span><span class="n">degraded_image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
<span class="n">restored_image_rl30</span> <span class="o">=</span> <span class="n">richardson_lucy</span><span class="p">(</span><span class="n">degraded_image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="n">iters_rl</span><span class="p">)</span>
<span class="n">restored_image_rlski</span> <span class="o">=</span> <span class="n">restoration</span><span class="o">.</span><span class="n">richardson_lucy</span><span class="p">(</span><span class="n">degraded_image</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">kernel</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">num_iter</span><span class="o">=</span><span class="n">iters_rl</span><span class="p">)</span>


<span class="c1"># Display the results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">degraded_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Degraded Image&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">restored_image_ft</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Restored Image (Fourier Deconvolution)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">restored_image_rl30</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Restored Image (Richardson-Lucy, </span><span class="si">{</span><span class="n">iters_rl</span><span class="si">}</span><span class="s1"> iters)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kernel shape: torch.Size([11, 11])
</pre></div>
</div>
<img alt="_images/3106d14c753c93a8f8f44b98c9dc6a06a81d2985b492c2ba35d37310611993cf.png" src="_images/3106d14c753c93a8f8f44b98c9dc6a06a81d2985b492c2ba35d37310611993cf.png" />
</div>
</div>
</section>
<section id="discussion">
<h4>Discussion<a class="headerlink" href="#discussion" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>De-convolution by fourier transform doesnâ€™t work. The image is unrecognisable and the noise seems to have been amplified by the de-convolution.</p></li>
<li><p>The Richardson Lucy algorithm removes most of the noise and also helps to de-blur the image. The contrast on the new image isnâ€™t as clear as the original image but is much better than the observed image.</p></li>
<li><p>The skimage implementation of the RLA has the same effect as the one programmed above with no noticeable difference for 5 iterations. However for a larger number of iterations the above implementation causes the image to become very dark. Prehaps this is due to the normalisation factor <span class="math notranslate nohighlight">\(\frac{f'^t_i}{\hat{f}^{t}_i}\)</span> always being less than 1. It is unclear why this is happening.</p></li>
<li><p>Although the RLA seems to work for the complex image (pigeon) the darkening after a larger number of iterations is concerning. Each time the convolution kernel is applied over the image it makes the image smaller, therefore padding is used to keep the image the same size. The padding involves adding zeros to the edge of the image where the convolution cannot be applied. This means that the edge of the image is darker than the rest of the image. The RLA is an iterative process and therefore this darkening effect is amplified each time the convolution kernel is applied, therefore the image becomes darker after many iterations especially when the kernel size and standard deviation are large.</p></li>
</ul>
</section>
</section>
<span id="document-Week3/2richardsonlucy"></span><section class="tex2jax_ignore mathjax_ignore" id="tuning-the-richardson-lucy-algorithm-with-1d-functions">
<h3>Tuning the Richardson-Lucy Algorithm with 1D functions<a class="headerlink" href="#tuning-the-richardson-lucy-algorithm-with-1d-functions" title="Link to this heading">#</a></h3>
<p>Its faster and simpler to experiment with 1D functions than 2D images. The same algorithm is used in 1D as it is in 2D. Furthermore there is more 1D data than 2D data.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="aims">
<h3>Aims<a class="headerlink" href="#aims" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Understand how random noise is changed by convolution</p></li>
<li><p>Test the Richardson-Lucy Algorithm (RLA) in 1D</p></li>
<li><p>Tune the RLA parameters in order to maximize PSNR (peak signal to noise ratio) and SSIM (structural similarity index measure).</p></li>
</ul>
<section id="deconvolving-a-1d-signal">
<h4>Deconvolving a 1D signal<a class="headerlink" href="#deconvolving-a-1d-signal" title="Link to this heading">#</a></h4>
<p>A square wave was convolved using a gaussian kernel and then poisson noise was added. The square wave was normalized between <span class="math notranslate nohighlight">\(0\)</span> and <span class="math notranslate nohighlight">\(1\)</span> as this was the 2D signal (image) was prepared as the same algorithms were used. The RLA was then used to try and recover the original signal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">ImageDebluring</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>


<span class="k">def</span> <span class="nf">step_function</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">(((</span><span class="n">xs</span><span class="o">.</span><span class="n">round</span><span class="p">()</span> <span class="o">%</span> <span class="n">period</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span>

<span class="k">def</span> <span class="nf">sin_function</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">period</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span>

<span class="k">def</span> <span class="nf">pigeon_function</span><span class="p">():</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;Images/pigeon.jpeg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>  <span class="c1"># Convert to grayscale</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)),</span>  <span class="c1"># Resize to 1x1000</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
    <span class="p">])</span>
    <span class="n">img_tensor</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># Remove channel dimension</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span> <span class="n">img_tensor</span>


<span class="k">def</span> <span class="nf">plot_deblurring_example</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">padding_mode</span> <span class="o">=</span> <span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Add batch and channel dimensions</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">gaussian_normalised_kernel_1D</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">61</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span>

    <span class="n">blurred_signal</span> <span class="o">=</span> <span class="n">convolution_1D</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">)</span>
    <span class="n">measured_signal</span> <span class="o">=</span> <span class="n">add_poisson_noise</span><span class="p">(</span><span class="n">blurred_signal</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span><span class="p">)</span>

    <span class="n">deblurred_signal</span> <span class="o">=</span> <span class="n">richardson_lucy</span><span class="p">(</span><span class="n">measured_signal</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Step Function&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">measured_signal</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Measured Signal (Blurred + Noisy)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">blurred_signal</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Blurred Signal&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">deblurred_signal</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimated Signal (Richardson-Lucy, </span><span class="si">{</span><span class="n">num_iters</span><span class="si">}</span><span class="s1"> iters)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">torch</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">ImageDebluring</span> <span class="kn">import</span> <span class="o">*</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torch&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="padding">
<h4>Padding<a class="headerlink" href="#padding" title="Link to this heading">#</a></h4>
<p>After a convolution the size of the image decreases since the kernel cannot be applied around edge pixels. For a kernel of size <span class="math notranslate nohighlight">\(n\)</span> and an image of size <span class="math notranslate nohighlight">\(m\)</span> the convoluted image will have size <span class="math notranslate nohighlight">\(m-n+1\)</span>. This is problematic since the LRA requires the measured image and the kernel to be the same size. Padding increases the size of the image by adding pixels around the edge.</p>
<ul class="simple">
<li><p>Zeros padding: the easiest to implement form of padding. The edge pixels are set to zero. The problem with zeros padding is that overtime it will decrease the overall brightness of the image starting from the edges. This means that a more iterations will gradually decrease the brightness of the image.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_deblurring_example</span><span class="p">(</span><span class="n">pigeon_function</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Zeros Padding&#39;</span><span class="p">,</span> <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f682e7c774a672e5104de5920d433e1c90133dd6a77b437a11840d27101c3224.png" src="_images/f682e7c774a672e5104de5920d433e1c90133dd6a77b437a11840d27101c3224.png" />
</div>
</div>
<p>The measured signal is far from the true signal since the edge pixels are much darker due to the zeros padding. Here there are also erroneous results since some pixel intensities are greater than 1.</p>
<ul class="simple">
<li><p>replicate padding repeats the value of the edge pixels. This means that the overall image is not darkened like when using zeros padding.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_deblurring_example</span><span class="p">(</span><span class="n">pigeon_function</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Replicate Padding&#39;</span><span class="p">,</span> <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/040571555b77b263325d200b73ee59db367ddec467a0c80b4ff037f4ee96c655.png" src="_images/040571555b77b263325d200b73ee59db367ddec467a0c80b4ff037f4ee96c655.png" />
</div>
</div>
<p>The replicate padding works much more successfully as there isnâ€™t issues around edge pixels. The image will not lose brightness over time.</p>
</section>
<section id="measures-of-image-quality">
<h4>Measures of image quality<a class="headerlink" href="#measures-of-image-quality" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(R^2\)</span> measures the correlation between the estimated signal and the true signal. However this has low human visual relevance. A higher <span class="math notranslate nohighlight">\(R^2\)</span> indicates that the overall shape of the estimated signal is a close match to the true signal.</p></li>
<li><p>MSE measures the average squared difference between the estimated signal and the true signal. Again this has low human visual relevance. This doesnâ€™t capture perceptual image quality well. A lower MSE indicates a higher quality image.</p></li>
<li><p>The PSNR is the logarithmic ratio between signal power to error power and is given in db since its logarithmic. This has a higher visual relevance compared to MSE. A value between 30 and 50 db indicates that the image is a good quality. Below 25db indicates heavy distortion or noise.</p></li>
<li><p>The SSIM compares the luminance, contrast and structure of the estimated signal to the true signal. This has a high visual relevance. A SSIM of 1 indicates a perfect match to the true signal a SSIM of above 0.97 indicates a good match a SSIM of below 0.95 indicates significant degregation.</p></li>
</ul>
</section>
<section id="number-of-iterations">
<h4>Number of iterations<a class="headerlink" href="#number-of-iterations" title="Link to this heading">#</a></h4>
<p>Its also easier to find training datasets for machine learning algorithms in 1D. The Richardson lucy algorithm has 3 â€œtuning parametersâ€ the first is the convolution kernel which is assumed to be a gaussian with known standard deviation. The second is the number of iterations the algorithm runs for. The third is the initial guess. The following graphs show how the number of iterations of the RLA effects how close the estimated signal is to the true signal. The results from this section will be used to help train a machine learning algorithm to predict the optimal number of iterations for a given image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torchmetrics</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">metrics</span>

<span class="k">def</span> <span class="nf">plot_iterations_example</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">padding_mode</span> <span class="o">=</span> <span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">5000</span>
                            <span class="p">,</span> <span class="n">iters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">],</span> <span class="n">plot_all</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">gaussian_normalised_kernel_1D</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">61</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span>
    <span class="n">blurred_signal</span> <span class="o">=</span> <span class="n">convolution_1D</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">)</span>
    <span class="n">measured_signal</span> <span class="o">=</span> <span class="n">add_poisson_noise</span><span class="p">(</span><span class="n">blurred_signal</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span><span class="p">)</span>
    <span class="n">r2s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mses</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">PSNRs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">SSIMs</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">plot_all</span><span class="p">:</span>
        <span class="n">fig1</span><span class="p">,</span> <span class="n">axs1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">axs1</span> <span class="o">=</span> <span class="n">axs1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">iters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">deblurred_signal</span> <span class="o">=</span> <span class="n">richardson_lucy</span><span class="p">(</span><span class="n">measured_signal</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">torchmetrics</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">deblurred_signal</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="n">mse</span> <span class="o">=</span> <span class="n">torchmetrics</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">deblurred_signal</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="n">r2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">mses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">PSNR</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">mse</span><span class="p">)</span>
        <span class="n">SSIM</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">structural_similarity</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">deblurred_signal</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">data_range</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">PSNRs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PSNR</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">SSIMs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SSIM</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">iters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iters</span> <span class="ow">and</span> <span class="n">plot_all</span><span class="p">:</span>
            <span class="n">axs1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">deblurred_signal</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">axs1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">measured_signal</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">axs1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">axs1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="c1">#axs1[j].legend([&#39;Estimated Signal&#39;, &#39;Measured Signal&#39;, &#39;True Signal&#39;], framealpha=1.0)</span>
            <span class="n">axs1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Richardson-Lucy: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> iters&#39;</span><span class="p">)</span>
            <span class="n">axs1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;RÂ² = </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axs1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        
        
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">axs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">PSNRs</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iterations&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PSNR&#39;</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">SSIMs</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iterations&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;SSIM&#39;</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_iterations_example</span><span class="p">(</span><span class="n">step_function</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Replicate Padding&#39;</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">iters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">],</span> <span class="n">period</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>25.0 %999999999998 %
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">IndexError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">plot_iterations_example</span><span class="p">(</span><span class="n">step_function</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Replicate Padding&#39;</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">iters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">],</span> <span class="n">period</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span>

<span class="nn">Cell In[4], line 34,</span> in <span class="ni">plot_iterations_example</span><span class="nt">(func, padding_mode, title, scale_factor, iters, plot_all, fig, axs, label, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span> <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">iters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iters</span> <span class="ow">and</span> <span class="n">plot_all</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">34</span>     <span class="n">axs1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">deblurred_signal</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span>     <span class="n">axs1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">measured_signal</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span>     <span class="n">axs1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="ne">IndexError</span>: index 6 is out of bounds for axis 0 with size 6
</pre></div>
</div>
<img alt="_images/a2b70d72b7a2ea37a26bb6baa525ec3565f83256cecacab90fcf780476dbfb93.png" src="_images/a2b70d72b7a2ea37a26bb6baa525ec3565f83256cecacab90fcf780476dbfb93.png" />
</div>
</div>
<p>When the number of iterations are low the estimated signal is smooth and this doesnâ€™t reflect the shape of the true signal, especially around the vertical lines. As the number of iterations increases the shape of the estimated signal improves. The steepness of the lines from where the square wave changes value value increases. However as the number of iterations increases the noise from the estimated signal also increases. Often the signal will become noisy even when there is no noise in the measured signal.</p>
<p>It is clear from both the graph of <span class="math notranslate nohighlight">\(R^2\)</span> score against iteration and the graph of MSE against iteration that the RLA is converging towards a solution. This solution doesnâ€™t appear to be the optimal solution since after 200 iterations the <span class="math notranslate nohighlight">\(R^2\)</span> value hadnâ€™t yet hit <span class="math notranslate nohighlight">\(0.95\)</span>. Similarly the MSE seems to be converging to a value at about <span class="math notranslate nohighlight">\(0.003\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_iterations_example</span><span class="p">(</span><span class="n">sin_function</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Replicate Padding&#39;</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">iters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100.0 %9999999999 %%
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1200x500 with 2 Axes&gt;,
 array([&lt;Axes: xlabel=&#39;Iterations&#39;, ylabel=&#39;PSNR&#39;&gt;,
        &lt;Axes: xlabel=&#39;Iterations&#39;, ylabel=&#39;SSIM&#39;&gt;], dtype=object))
</pre></div>
</div>
<img alt="_images/6db4bdb04d9021f7ceabe2dd3de51ef764e5806281255bbe6d275d4b6706dad2.png" src="_images/6db4bdb04d9021f7ceabe2dd3de51ef764e5806281255bbe6d275d4b6706dad2.png" />
<img alt="_images/1f7fad8baf6e2ced99b2050eb1af764642a65d54dca0c8fc7ecb11fed3d37e15.png" src="_images/1f7fad8baf6e2ced99b2050eb1af764642a65d54dca0c8fc7ecb11fed3d37e15.png" />
</div>
</div>
<p>In this example the convolution doesnâ€™t make so much difference to the true signal as its smoother. This means that there is less to be gained by carrying out more iterations of the RLA since the shape of the signal is already satisfactory. Carrying out more iterations just adds noise to the signal although this seems relativly insignificant as seen from the very large <span class="math notranslate nohighlight">\(R^2\)</span> value of <span class="math notranslate nohighlight">\(0.998\)</span>.</p>
<p>Here the RLA initially gets very close to the true signal but then starts to diverge after 10 iterations. The reasons for this are unclear but may be to do with specific frequencies which the RLA is amplifying. By extending the graph it is clear that it doesnâ€™t seem to a solution after 1000 iterations, perhaps the rate of convergence is very slow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_iterations_example</span><span class="p">(</span><span class="n">pigeon_function</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Replicate Padding&#39;</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">iters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100.0 %9999999999 %%
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1200x500 with 2 Axes&gt;,
 array([&lt;Axes: xlabel=&#39;Iterations&#39;, ylabel=&#39;PSNR&#39;&gt;,
        &lt;Axes: xlabel=&#39;Iterations&#39;, ylabel=&#39;SSIM&#39;&gt;], dtype=object))
</pre></div>
</div>
<img alt="_images/ab11251717e1b743d799d9468b97ddfd6187a313473ffdc0b8f9d0fd965165f4.png" src="_images/ab11251717e1b743d799d9468b97ddfd6187a313473ffdc0b8f9d0fd965165f4.png" />
<img alt="_images/ea7c37fa294ecd32d26a0cb84588f82e8ffc3a39f2c4f4c6c180654a57e20026.png" src="_images/ea7c37fa294ecd32d26a0cb84588f82e8ffc3a39f2c4f4c6c180654a57e20026.png" />
</div>
</div>
<p>After about 4 iterations the RLA has got as close as it gets to the true signal with a <span class="math notranslate nohighlight">\(R^2\)</span> of about 0.993. After this the RLA diverges away from the true signal as the estimated signal becomes very noisy. The divergence in this case is much worse than in the previous example. This suggests that the number of iterations is an important variable to tune using machine learning.</p>
</section>
<section id="conclusion">
<h4>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h4>
<p>Padding is necessary to keep the signal size the same after convolution which is essential in the RLA. Replicate padding doesnâ€™t cause the images to darken over time and prevents artifacts being introduced into the solution due to boundary effects.</p>
<p>The number of iterations effects how close the estimated signal can get to the true signal. Selecting a number of iterations is a tradeoff between how well the shape of the estimated signal matches the true signal and how noisy the estimated signal is. The optimal number of iterations seems to be lower for real world signals perhaps due to the different frequency components of the signal.</p>
</section>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-Week7/MachineLearningFunction"></span><section class="tex2jax_ignore mathjax_ignore" id="neural-networks-for-image-de-noising">
<h3>Neural Networks for Image De-noising<a class="headerlink" href="#neural-networks-for-image-de-noising" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Understand how multi-layer neural networks function.</p></li>
<li><p>Build a multi layer perceptron that can analyze and deconvolve step functions</p></li>
</ul>
<section id="theory">
<h4>Theory<a class="headerlink" href="#theory" title="Link to this heading">#</a></h4>
<p>Assume the noisy image can be written as a matrix <span class="math notranslate nohighlight">\(P_{i}\)</span> where each element represents the pixel intensity of the <span class="math notranslate nohighlight">\(i\)</span> th pixel. The goal is to train a neural network <span class="math notranslate nohighlight">\(f(P; K)\)</span> where <span class="math notranslate nohighlight">\(K\)</span> is the known convolution kernel to output a denoised image <span class="math notranslate nohighlight">\(Q_{i} = f(P; K)\)</span>. The nodes between the inputs and the outputs are the â€˜hidden nodesâ€™. All nodes have a value between 0 and 1.</p>
<p>The node <span class="math notranslate nohighlight">\(a^{(1)}_0\)</span> will have its value computed from a sum of the weighted inputs from the first layer.</p>
<div class="math notranslate nohighlight">
\[a^{(1)}_0 = \sigma(b_0+\sum_{i} w_{i}P_{i})\]</div>
<p>Where <span class="math notranslate nohighlight">\(\sigma\)</span> is the normalisation function given by <span class="math notranslate nohighlight">\(\sigma(x) = \frac{1}{1 + e^{-x}}\)</span>. <span class="math notranslate nohighlight">\(w_{i}\)</span> are the weights associated with each input pixel <span class="math notranslate nohighlight">\(P_{i}\)</span>, <span class="math notranslate nohighlight">\(b_0\)</span> is the bias term.</p>
<p>The first next layer of hidden nodes can be calculated from:</p>
<div class="math notranslate nohighlight">
\[\mathbf{a}^{(i+1)} = \sigma(W^{(i)}\mathbf{a}^{(i)} + \mathbf{b}^{(i)})\]</div>
<p>Where <span class="math notranslate nohighlight">\(W^{(i)}\)</span> is the weight matrix and <span class="math notranslate nohighlight">\(\mathbf{b}^{(i)}\)</span> is the bias vector which transforms the <span class="math notranslate nohighlight">\(i\)</span> th layer into the <span class="math notranslate nohighlight">\(i+1\)</span> th layer. The values of <span class="math notranslate nohighlight">\(W^{(i)}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{b}^{(i)}\)</span> are learned during training.</p>
</section>
<section id="gradient-descent">
<h4>Gradient Descent<a class="headerlink" href="#gradient-descent" title="Link to this heading">#</a></h4>
<p>The cost function measures the success of the machine learning algorithm one way it could be defined is as follows:</p>
<div class="math notranslate nohighlight">
\[C(\mathbf{w}) = \sum_i (\hat{p}_i - p_i)^2\]</div>
<p>Where <span class="math notranslate nohighlight">\(\hat{p}_i\)</span> is the estimated state from the MLP and <span class="math notranslate nohighlight">\(p_i\)</span> is the known state. The vector <span class="math notranslate nohighlight">\(\mathbf{w}\)</span> contains all the weights in the network. This sum is small when the network is close to being â€œcorrectâ€.</p>
<p>Using gradient decent can be used to find a local minima, an optimized solution. The vector <span class="math notranslate nohighlight">\(-\Delta C(\mathbf{w})\)</span> points in the direction of steepest decent.</p>
</section>
<section id="generate-test-data">
<h4>Generate test data<a class="headerlink" href="#generate-test-data" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">ImageDebluring</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="k">def</span> <span class="nf">step_function</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">y_intercept</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">x_offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">steps</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">heaviside</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">xs</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">)</span> <span class="o">/</span> <span class="n">period</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span> <span class="o">+</span> <span class="n">y_intercept</span>
    <span class="k">return</span> <span class="n">ys</span>

<span class="k">def</span> <span class="nf">generate_random_function</span><span class="p">(</span><span class="n">vary_period</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vary_amplitude</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vary_y_intercept</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vary_x_offset</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vary_period</span><span class="p">:</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="n">vary_amplitude</span><span class="p">:</span>
        <span class="n">amplitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="mf">0.1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">amplitude</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="k">if</span> <span class="n">vary_y_intercept</span><span class="p">:</span>
        <span class="n">y_intercept</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_intercept</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="k">if</span> <span class="n">vary_x_offset</span><span class="p">:</span>
        <span class="n">x_offset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_offset</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">step_function</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">y_intercept</span><span class="p">,</span> <span class="n">x_offset</span><span class="o">=</span><span class="n">x_offset</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">generate_test_data</span><span class="p">(</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">noise_scale</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">blur_std</span> <span class="o">=</span> <span class="mi">61</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">vary_period</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vary_amplitude</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vary_y_intercept</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vary_x_offset</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_scalers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">X_scalers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">amount</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">generate_random_function</span><span class="p">(</span><span class="n">vary_period</span> <span class="o">=</span> <span class="n">vary_period</span><span class="p">,</span> <span class="n">vary_amplitude</span> <span class="o">=</span> <span class="n">vary_amplitude</span><span class="p">,</span> <span class="n">vary_y_intercept</span> <span class="o">=</span> <span class="n">vary_y_intercept</span><span class="p">,</span> <span class="n">vary_x_offset</span> <span class="o">=</span> <span class="n">vary_x_offset</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span><span class="p">)</span>
        <span class="n">degraded_data</span> <span class="o">=</span> <span class="n">degrade_image_1D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">noise_scale</span><span class="o">=</span><span class="n">noise_scale</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">gaussian_normalised_kernel_1D</span><span class="p">(</span><span class="n">blur_std</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">),</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">)</span>
        <span class="n">scaler_x</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">scaler_y</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="c1"># reshape to 2D (n_samples, n_features) for sklearn, then back to 1D</span>
        <span class="n">degraded_np</span> <span class="o">=</span> <span class="n">degraded_data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">data_np</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">degraded_scaled</span> <span class="o">=</span> <span class="n">scaler_x</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">degraded_np</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler_y</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data_np</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">degraded_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">degraded_scaled</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">X_scalers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scaler_x</span><span class="p">)</span>
        <span class="n">y_scalers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scaler_y</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">degraded_data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        
    <span class="c1"># Make tensors</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">X_scalers</span><span class="p">,</span> <span class="n">y_scalers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">torch</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">ImageDebluring</span> <span class="kn">import</span> <span class="o">*</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torch&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="defining-the-mlp-model">
<h4>Defining the MLP model<a class="headerlink" href="#defining-the-mlp-model" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>input size for this dataset is 1000 (number of points in the 1D signal)</p></li>
<li><p>hidden size can be adjusted, start with 128</p></li>
<li><p>output size is also 1000 (number of points in the 1D signal)</p></li>
<li><p>requires_grad=True to enable backpropagation</p></li>
</ul>
</section>
<section id="forward-pass">
<h4>Forward Pass<a class="headerlink" href="#forward-pass" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Linear transformation of inputs <span class="math notranslate nohighlight">\(z^{(1)} = XW^{(1)} + b^{(1)}\)</span></p></li>
<li><p>Apply activation function <span class="math notranslate nohighlight">\(a^{(1)} = \sigma(z^{(1)})\)</span> to node values</p></li>
<li><p>Linear transformation of hidden layer <span class="math notranslate nohighlight">\(z^{(2)} = a^{(1)}W^{(2)} + b^{(2)}\)</span></p></li>
<li><p>Apply activation function <span class="math notranslate nohighlight">\(a^{(2)} = \sigma(z^{(2)})\)</span> to get final output</p></li>
</ul>
</section>
<section id="backpropagation">
<h4>Backpropagation<a class="headerlink" href="#backpropagation" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">backward</span></code> updates the weights and the baises</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">epochs</span></code> the number of times the model sees the entire dataset</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lr</span></code> hyperparameter that controls the step size for weighted updates</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">loss</span></code> the MSE</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MLP</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z1</span><span class="p">)</span> <span class="c1"># applies sigmoid activation function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W2</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z2</span><span class="p">)</span> 
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2</span>
    
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dz2</span> <span class="o">=</span> <span class="n">output</span> <span class="o">-</span> <span class="n">y</span>
        <span class="n">dW2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dz2</span><span class="p">)</span>
        <span class="n">db2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dz2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">m</span>
        
        <span class="n">da1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dz2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">dz1</span> <span class="o">=</span> <span class="n">da1</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">))</span>
        <span class="n">dW1</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">dz1</span><span class="p">)</span><span class="o">/</span><span class="n">m</span>
        <span class="n">db1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dz1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span>
        
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W1</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">dW1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b1</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">db1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W2</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">dW2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b2</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">db2</span>
            
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">losses&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="c1"># Compute loss using MSE</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">output</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="c1"># Update weights</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">, Loss: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">losses</span>
        
</pre></div>
</div>
</div>
</div>
</section>
<section id="initialize-model">
<h4>Initialize model<a class="headerlink" href="#initialize-model" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_losses</span><span class="p">(</span><span class="n">losses</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)),</span>  <span class="n">losses</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_scaled</span><span class="p">,</span> <span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">input_size</span> <span class="o">=</span> <span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span><span class="p">)</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_scaled</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
    <span class="n">plot_losses</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="testing">
<h4>Testing<a class="headerlink" href="#testing" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">amount</span></code> is the number of waves that are generated for training and testing</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">noise_scale</span></code> is the scale factor for the signal before poisson noise is added</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">blur_std</span></code> is the standard devation of the guassian being convolved with the signal</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kernel_size</span></code> is the size of the guassian being convolved with teh signal</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">epochs</span></code> is the number of iterations that the machine learning algorithm will train for</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lr</span></code> is the hyperparameter that controls the step size for weighted updates</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hidden_size</span></code> the number of hidden nodes in the MLP</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vary_period/amplitude/y_intercept/x_offset</span></code> boolean describes if these should be variables when generating the waves.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">X/y</span></code> an optional parameter which if not provided the programme will generate its own data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">X/y-scalers</span></code> scalers so data can be unscaled after running through the machine learning algorithm</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="k">def</span> <span class="nf">test_model</span><span class="p">(</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">noise_scale</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">blur_std</span> <span class="o">=</span> <span class="mi">61</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">vary_period</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vary_amplitude</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vary_y_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vary_x_offset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">seed_data</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">seed_model</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">X_scalers</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y_scalers</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">X</span>
        <span class="n">y_scaled</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">rng_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed_data</span><span class="p">)</span>
    <span class="n">rng_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed_model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating data...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_scaled</span><span class="p">,</span> <span class="n">y_scaled</span><span class="p">,</span> <span class="n">X_scalers</span><span class="p">,</span> <span class="n">y_scalers</span> <span class="o">=</span> <span class="n">generate_test_data</span><span class="p">(</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span><span class="p">,</span> <span class="n">noise_scale</span> <span class="o">=</span> <span class="n">noise_scale</span><span class="p">,</span> <span class="n">blur_std</span> <span class="o">=</span> <span class="n">blur_std</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">vary_period</span> <span class="o">=</span> <span class="n">vary_period</span><span class="p">,</span> <span class="n">vary_amplitude</span> <span class="o">=</span> <span class="n">vary_amplitude</span><span class="p">,</span> <span class="n">vary_y_intercept</span> <span class="o">=</span> <span class="n">vary_y_intercept</span><span class="p">,</span> <span class="n">vary_x_offset</span> <span class="o">=</span> <span class="n">vary_x_offset</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">rng_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data generated&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_train_scaled</span><span class="p">,</span> <span class="n">y_test_scaled</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y_scaled</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data preppared&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_scaled</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span><span class="p">,</span> <span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">rng_model</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Model trained&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">y_pred_scaled</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
    
    <span class="c1"># Select 4 waves to vosialise</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_scalers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_pred_scaled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_scalers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_scalers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_test_scaled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)),</span> <span class="n">y</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;predicted&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)),</span> <span class="n">y</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;degraded&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)),</span> <span class="n">y</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;original&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="simplest-model">
<h4>Simplest model<a class="headerlink" href="#simplest-model" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Simple model where the parameters defining the square wave are the same for each iteration</p></li>
<li><p>the only thing that changes is the noise that is added to the square waves each time</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_model</span><span class="p">(</span><span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Generating data...
Data generated
Data preppared
losses
Epoch 9, Loss: 3.0431750869253094e-11
Model trained
Done!
</pre></div>
</div>
<img alt="_images/74d369c28700ffc220f4041df41234ad9824e11207168d9158ca672fa3c0c129.png" src="_images/74d369c28700ffc220f4041df41234ad9824e11207168d9158ca672fa3c0c129.png" />
<img alt="_images/ebfed17451ea45ca0a4cdf463c02bb7b707854a044b4e9411f8b7b8e6147f953.png" src="_images/ebfed17451ea45ca0a4cdf463c02bb7b707854a044b4e9411f8b7b8e6147f953.png" />
</div>
</div>
<ul class="simple">
<li><p>Converges very quickly</p></li>
<li><p>the predicted waves are identical to the square waves</p></li>
</ul>
</section>
<section id="varying-the-x-offset">
<h4>Varying the x offset<a class="headerlink" href="#varying-the-x-offset" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>now also varying the x offset which is generated randomly</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">X_scalers</span><span class="p">,</span> <span class="n">y_scalers</span> <span class="o">=</span> <span class="n">generate_test_data</span><span class="p">(</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">noise_scale</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">blur_std</span> <span class="o">=</span> <span class="mi">61</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">vary_x_offset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_model</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">seed_data</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">seed_model</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">X_scalers</span> <span class="o">=</span> <span class="n">X_scalers</span><span class="p">,</span> <span class="n">y_scalers</span> <span class="o">=</span> <span class="n">y_scalers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data preppared
losses
Epoch 29, Loss: 0.32221731543540955
Model trained
Done!
</pre></div>
</div>
<img alt="_images/e1abf5acb61ace925b932b9929d7997bbcfa76a81e9bdcb7c6ea8ddd3bbe3b4f.png" src="_images/e1abf5acb61ace925b932b9929d7997bbcfa76a81e9bdcb7c6ea8ddd3bbe3b4f.png" />
<img alt="_images/c580de8f5889a73d00ea71b87dcae8bdc0a2cb30d08a190ef5181695f12dac6d.png" src="_images/c580de8f5889a73d00ea71b87dcae8bdc0a2cb30d08a190ef5181695f12dac6d.png" />
</div>
</div>
<ul class="simple">
<li><p>This example doesnâ€™t work</p></li>
<li><p>loss vs epoch is noisy</p></li>
<li><p>considered decreasing <code class="docutils literal notranslate"><span class="pre">lr</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_model</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">X_scalers</span> <span class="o">=</span> <span class="n">X_scalers</span><span class="p">,</span> <span class="n">y_scalers</span> <span class="o">=</span> <span class="n">y_scalers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data preppared
losses
Epoch 49, Loss: 0.0021088530775159597
Model trained
Done!
</pre></div>
</div>
<img alt="_images/db98dc1d01269d903950c424f69d1166cf6fbd4cb9758aa5209cd44352f117dd.png" src="_images/db98dc1d01269d903950c424f69d1166cf6fbd4cb9758aa5209cd44352f117dd.png" />
<img alt="_images/41ac4839ae07c23aee2ac8c2d4ee87aba064a80bcb974241b3980d07553e0058.png" src="_images/41ac4839ae07c23aee2ac8c2d4ee87aba064a80bcb974241b3980d07553e0058.png" />
</div>
</div>
<ul class="simple">
<li><p>fixes the problem model fits data well</p></li>
</ul>
</section>
<section id="modifying-x-offset-y-intercept-period-and-amplitude">
<h4>modifying x offset, y intercept, period and amplitude<a class="headerlink" href="#modifying-x-offset-y-intercept-period-and-amplitude" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_model</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">seed_model</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">X_scalers</span> <span class="o">=</span> <span class="n">X_scalers</span><span class="p">,</span> <span class="n">y_scalers</span> <span class="o">=</span> <span class="n">y_scalers</span><span class="p">,</span> <span class="n">vary_x_offset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vary_period</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vary_y_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vary_amplitude</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data preppared
losses
Epoch 199, Loss: 0.0021223679650574923
Model trained
Done!
</pre></div>
</div>
<img alt="_images/58a64cb80c597636461a88a0a38788838ccfaa20c42b903d54ba8e7f28a239bb.png" src="_images/58a64cb80c597636461a88a0a38788838ccfaa20c42b903d54ba8e7f28a239bb.png" />
<img alt="_images/5499ffec522b12a89a856865c9a77a13c28d8dac0f3b46f9eaabb4a75deb7254.png" src="_images/5499ffec522b12a89a856865c9a77a13c28d8dac0f3b46f9eaabb4a75deb7254.png" />
</div>
</div>
</section>
<section id="conclusion">
<h4>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h4>
<p>A MLP was sucessfully built which can deconvolve step functions. Future steps include blending this with the richardson lucy algorithm and then testing this on a broader range of functions. Prehaps building this code into a class would be more managable.</p>
</section>
</section>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Malachi Hibbins
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>